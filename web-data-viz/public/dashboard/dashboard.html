<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/logo.svg" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>

    <link rel="stylesheet" href="./../css/dashboards.css">
    <script src="../js/sessao.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body>
    <section class="container-dash">
        <aside class="sidebar">
            <div class="nav-bar">
                <img class="logo" src="../assets/logo.svg" alt="Stand Inside" />
                <nav role="navigation" aria-label="Menu principal">
                    <ul>
                        <li><a href="./home.html"><i class="fas fa-home"></i> Home</a></li>
                        <li><a href="./quiz.html" class="active"><i class="fas fa-clipboard-list"></i> Quizz</a></li>
                        <!-- <li><a href="#"><i class="fas fa-user-astronaut"></i> Seu Stand</a></li> -->
                        <li><a href="./dashboard.html"><i class="fas fa-chart-pie"></i> Dashbard</a></li>
                        <!-- <li><a href="#"><i class="fas fa-book-open"></i> Wiki</a></li> -->
                        <li><a href="#"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
                    </ul>
                </nav>
            </div>
            <hr>
            <div class="footer">
                <strong>Stand Inside</strong>
                © 2025 Todos os direitos reservados<br> <br>
                Feito com <span class="heart">❤️</span> pela aluna<br> <br>
                Beatriz Perez SpTech
            </div>
        </aside>
        <section class="content-section">
            <h1>Dashboard</h1>
            <div class="kpis">
                <div class="kpi-card">
                    <div class="circle"><i class="fa-solid fa-users"></i></div>
                    <div>
                        <p class="quantidade" id="quantidade-usuarios"></p>
                        <p>Comunidade Ativa</p>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="circle"><i class="fas fa-user-friends"></i></div>
                    <div>
                        <p class="quantidade" id="quantidade-personagem-igual"></p>
                        <p>Pessoas com o mesmo<br>Stand que você</p>
                    </div>
                </div>

                <div class="kpi-card opiniao-publico-card">
                    <h3>Opinião do público</h3>
                    <canvas id="graficoOpiniao"></canvas>
                </div>



            </div>

            <!-- <div class="stand">
                <img src="" alt="">
                <div class="descricao-personagem">
                    <h2></h2>
                    <p></p>
                </div>
            </div> -->

            <div class="dados"></div>
        </section>
    </section>
</body>

</html>

<script>

    window.onload = function () {
        atualizarQuantidadeUsuarios();
        atualizarQuantidadeMesmoStand();
        carregarGraficoOpiniao();
    };

    function atualizarQuantidadeUsuarios() {
        fetch("/dash/usuarios/contar")
            .then(resposta => {
                if (!resposta.ok) {
                    throw new Error("Erro ao buscar quantidade de usuários.");
                }
                return resposta.json();
            })
            .then(dados => {
                if (dados.total_usuarios !== undefined) {
                    document.getElementById("quantidade-usuarios").textContent = dados.total_usuarios;
                } else {
                    console.error("Resposta inválida da API:", dados);
                }
            })
            .catch(erro => {
                console.error("Erro ao carregar quantidade de usuários:", erro);
            });
    }

    function atualizarQuantidadeMesmoStand() {
        const idUsuario = sessionStorage.ID_USUARIO;

        if (!idUsuario) {
            console.error("ID do usuário não encontrado na sessão.");
            return;
        }

        fetch(`/dash/usuarios/mesmo-stand/${idUsuario}`)
            .then(resposta => {
                if (!resposta.ok) {
                    throw new Error("Erro ao buscar usuários com mesmo stand.");
                }
                return resposta.json();
            })
            .then(dados => {
                if (dados.total !== undefined) {
                    const totalOutros = dados.total - 1;
                    document.getElementById("quantidade-personagem-igual").textContent = totalOutros >= 0 ? totalOutros : 0;
                } else {
                    console.error("Resposta inválida da API:", dados);
                }
            })
            .catch(erro => {
                console.error("Erro ao carregar usuários com mesmo stand:", erro);
            });
    }


    let opiniaoChart;

    function carregarGraficoOpiniao() {
        fetch('/dash/relatorio/concordancia')
            .then(res => res.json())
            .then(dados => {
                const labels = [];
                const valores = [];
                const cores = [];

                dados.forEach(item => {
                    labels.push(item.situacao);
                    valores.push(item.quantidade);

                    if (item.situacao === 'Concorda') {
                        cores.push('#B2E200');
                    } else if (item.situacao === 'Discorda') {
                        cores.push('#F3FBD9');
                    } else if (item.situacao === 'Não respondeu') {
                        cores.push('#888888');
                    }
                });

                const ctx = document.getElementById('graficoOpiniao').getContext('2d');

                if (opiniaoChart) opiniaoChart.destroy();

                opiniaoChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: valores,
                            backgroundColor: cores,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right',
                                labels: {
                                    color: '#ffffff',
                                    boxWidth: 20,
                                    padding: 20,
                                    font: {
                                        size: 16
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(console.error);
    }

</script>